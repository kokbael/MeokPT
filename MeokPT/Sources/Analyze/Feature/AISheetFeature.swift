import ComposableArchitecture
import Foundation
import FirebaseAI

struct AISheetFeature: Reducer {
    @ObservableState
    struct State: Equatable {
        var generatedResponse: String = "AI ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ìž…ë‹ˆë‹¤..."
        var isLoading: Bool = false
        var errorMessage: String? = nil
    }

    enum Action: Equatable {
        static func == (lhs: AISheetFeature.Action, rhs: AISheetFeature.Action) -> Bool {
            switch (lhs, rhs) {
            case (.onAppear, .onAppear):
                return true
            case (.aiResponse(let lhsResult), .aiResponse(let rhsResult)):
                switch (lhsResult, rhsResult) {
                case (.success(let lhsString), .success(let rhsString)):
                    return lhsString == rhsString
                case (.failure(let lhsError), .failure(let rhsError)):
                    return lhsError.localizedDescription == rhsError.localizedDescription
                default:
                    return false
                }
            default:
                return false
            }
        }
        
        case onAppear
        case aiResponse(Result<String, Error>)
    }
    
    @Dependency(\.firebaseAIService) var firebaseAIService
    
    func reduce(into state: inout State, action: Action) -> Effect<Action> {
        switch action {
        case .onAppear:
            guard !state.isLoading && state.generatedResponse == "AI ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ìž…ë‹ˆë‹¤..." else {
                return .none
            }
            state.isLoading = true
            return .run { send in
                // MARK: - MOCK ë°ì´í„° ì‚¬ìš©
                let recommendedIntakeItems = mockNutritionItems
                let consumedDietItems: [Diet] = [
                    Diet(mealType: "ì•„ì¹¨", title: "ìŠ¤í¬ëž¨ë¸” ì—ê·¸ì™€ í† ìŠ¤íŠ¸", kcal: 450, carbohydrate: 60, protein: 20, fat: 15, dietaryFiber: 5, sugar: 10, sodium: 300, isFavorite: false),
                    Diet(mealType: "ì ì‹¬", title: "ì¹˜í‚¨ ìƒëŸ¬ë“œ", kcal: 600, carbohydrate: 70, protein: 30, fat: 20, dietaryFiber: 8, sugar: 15, sodium: 500, isFavorite: true)
                ]
                
                guard let nutritionInputForJSON = createNutritionInputForJSON(
                    userRecommendedIntakeItems: recommendedIntakeItems,
                    consumedDiets: consumedDietItems
                ) else {
                    await send(.aiResponse(.failure(NSError(domain: "DataProcessingError", code: 1, userInfo: [NSLocalizedDescriptionKey: "ì˜ì–‘ ì •ë³´ JSON ê°ì²´ ìƒì„± ì‹¤íŒ¨"]))))
                    return
                }
                
                let encoder = JSONEncoder()
                guard let jsonData = try? encoder.encode(nutritionInputForJSON),
                      let jsonInputString = String(data: jsonData, encoding: .utf8) else {
                    await send(.aiResponse(.failure(NSError(domain: "DataProcessingError", code: 1, userInfo: [NSLocalizedDescriptionKey: "ì˜ì–‘ ì •ë³´ JSON Encoding ì‹¤íŒ¨"]))))
                    return
                }
                        
                let prompt = """
                    # AI ì˜ì–‘ì‚¬: ì‹ë‹¨ ë¶„ì„ ë° ë§ˆí¬ë‹¤ìš´ ì¡°ì–¸ ìƒì„± ê°€ì´ë“œ

                    ë‹¹ì‹ ì€ ì‚¬ìš©ìžì˜ ì‹ë‹¨ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³ , ì˜ì–‘í•™ì  ì¡°ì–¸ì„ ì œê³µí•˜ëŠ” AI ì˜ì–‘ì‚¬ìž…ë‹ˆë‹¤.
                    ì œê³µë˜ëŠ” ì‚¬ìš©ìž ì •ë³´ì™€ ì‹ë‹¨ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì•„ëž˜ 'ì¶œë ¥ ê°€ì´ë“œë¼ì¸'ì— ë”°ë¼ ìƒì„¸í•˜ê³  ì¹œì ˆí•œ ë¶„ì„ ê²°ê³¼ë¥¼ **ë§ˆí¬ë‹¤ìš´(Markdown) í˜•ì‹ìœ¼ë¡œ ìƒì„±**í•´ì£¼ì„¸ìš”.
                    ê²°ê³¼ëŠ” ì‚¬ìš©ìžê°€ ë‚´ìš©ì„ ì‰½ê²Œ íŒŒì•…í•  ìˆ˜ ìžˆë„ë¡ ëª…í™•í•˜ê³  ê°„ê²°í•´ì•¼ í•˜ë©°, ì ìˆ˜ëŠ” í…ìŠ¤íŠ¸ë¡œ ëª…í™•ížˆ ì œì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
                    ì „ì²´ì ìœ¼ë¡œ ê¹”ë”í•˜ê³  ë³´ê¸° ì¢‹ì€ ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼(ì˜ˆ: ì ì ˆí•œ ì œëª© í¬ê¸°, ëª©ë¡ í™œìš©, ê°•ì¡°)ì„ ì ìš©í•´ì£¼ì„¸ìš”. ì‘ë‹µì€ ë‹¤ë¥¸ ì‹œìŠ¤í…œì— ì‰½ê²Œ í†µí•©ë  ìˆ˜ ìžˆëŠ” ìˆœìˆ˜ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ì—¬ì•¼ í•©ë‹ˆë‹¤.

                    ## ðŸ“Š ì¶œë ¥ ê°€ì´ë“œë¼ì¸:

                    AIëŠ” ë‹¤ìŒ ê°€ì´ë“œë¼ì¸ì— ë”°ë¼ **ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ** ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤. (ëª¨ë“  ì˜ˆì‹œëŠ” ìµœì¢… ì¶œë ¥ë¬¼ê³¼ ë™ì¼í•œ **ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì œê³µ**ë©ë‹ˆë‹¤.)

                    ë¨¼ì €, ìž…ë ¥ëœ ì‹ë‹¨ ë°ì´í„°ì—ì„œ 'ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…' ì‹ì‚¬ê°€ ëª¨ë‘ í¬í•¨ë˜ì–´ ìžˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. `consumedDiets` ë°°ì—´ ë‚´ ê°ì²´ì˜ `mealType` ê°’ì„ í™•ì¸í•˜ì—¬ íŒë‹¨í•©ë‹ˆë‹¤.
                
                    ### 1. ì•„ì¹¨, ì ì‹¬, ì €ë… ì‹ë‹¨ ì¤‘ í•˜ë‚˜ë¼ë„ ëˆ„ë½ëœ ê²½ìš°:

                    ëˆ„ë½ëœ ì‹ì‚¬ë¥¼ í¬í•¨í•˜ì—¬ ê° ì£¼ìš” ì‹ë‹¨(ì•„ì¹¨, ì ì‹¬, ì €ë…)ì— ëŒ€í•œ ê°œë³„ ë§ˆí¬ë‹¤ìš´ ë¶„ì„ ì„¹ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì €ë… ì‹ì‚¬ê°€ ëˆ„ë½ë˜ì—ˆë‹¤ë©´ ì•„ì¹¨, ì ì‹¬ ë¶„ì„ í›„ ì €ë… ì‹ì‚¬ ì¶”ì²œ ì„¹ì…˜ì„ í¬í•¨í•©ë‹ˆë‹¤. ë§Œì•½ ê°„ì‹ ë°ì´í„°ê°€ ìžˆë‹¤ë©´, ê°„ì‹ì— ëŒ€í•œ ë¶„ì„ë„ ì¶”ê°€í•©ë‹ˆë‹¤. (ì•„ëž˜ 3ë²ˆ ê°€ì´ë“œë¼ì¸ ì°¸ê³ )
                    ê° ì‹ë‹¨ ë¶„ì„(ë°ì´í„°ê°€ ìžˆëŠ” ê²½ìš°)ì—ëŠ” **100ì  ë§Œì ì˜ ì ìˆ˜(í…ìŠ¤íŠ¸ í˜•ì‹)**, í•´ë‹¹ ì‹ì‚¬ì˜ **ì£¼ìš” ê¸ì •ì  ì¸¡ë©´(1-2ê°€ì§€)**ê³¼ **êµ¬ì²´ì ì´ê³  ì‹¤ì²œ ê°€ëŠ¥í•œ ê°œì„ ì (1-2ê°€ì§€, ìŒì‹ ì¢…ë¥˜ ë° ì–‘ í¬í•¨)**ì´ ê°„ê²°í•˜ê²Œ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ê°œì„ ì  ì œì•ˆ ì‹œ, 'ë‹­ê°€ìŠ´ì‚´ 100g ì¶”ê°€' ë˜ëŠ” 'íŠ€ê¹€ ëŒ€ì‹  êµ¬ìš´ ì±„ì†Œ ì„ íƒ'ê³¼ ê°™ì´ ëª…í™•í•œ ìŒì‹ê³¼ ì¡°ë¦¬ë²•, ë˜ëŠ” ì–‘ì„ ì œì‹œí•´ì£¼ì„¸ìš”.
                    ë§Œì•½ íŠ¹ì • ì‹ì‚¬(ì˜ˆ: ì €ë…)ê°€ ëˆ„ë½ëœ ê²½ìš°, ë‹¨ìˆœížˆ 'ìž…ë ¥ë˜ì§€ ì•Šì•˜ìŒ'ìœ¼ë¡œ ëë‚´ì§€ ë§ê³ , **í•´ë‹¹ ë¼ë‹ˆì— ëŒ€í•œ ê°„ê²°í•˜ê³  ê±´ê°•í•œ ì‹ë‹¨ ì•„ì´ë””ì–´ í•œë‘ ê°€ì§€(ì˜ˆ: 'ì €ë…ì—” ê°€ë³ê²Œ ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œëŠ” ì–´ë– ì„¸ìš”?' ë˜ëŠ” 'ì €ë…ìœ¼ë¡œ í˜„ë¯¸ë°¥ê³¼ ëœìž¥êµ­, ë‚˜ë¬¼ë°˜ì°¬ì„ ì¶”ì²œí•©ë‹ˆë‹¤.')**ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”. ê°€ëŠ¥í•œ ê²½ìš°, ë‹¹ì¼ ì„­ì·¨ íŒ¨í„´ì— ê¸°ë°˜í•œ **ê°„ë‹¨í•œ íŒ(ì˜ˆ: 'ì ì‹¬ì— íŠ€ê¹€ì„ ë“œì…¨ìœ¼ë‹ˆ, ì €ë…ì€ ê¸°ë¦„ê¸° ì ì€ ë©”ë‰´ë¡œ ì„ íƒí•˜ì„¸ìš”.')**ì„ í•œ ë¬¸ìž¥ ë§ë¶™ì¼ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
                    ì ìˆ˜ ì‚°ì • ê¸°ì¤€: í•´ë‹¹ ì‹ì‚¬ê°€ í•˜ë£¨ ê¶Œìž¥ ì„­ì·¨ëŸ‰ì—ì„œ ì°¨ì§€í•˜ëŠ” ë¹„ìœ¨(ì˜ˆ: ì•„ì¹¨ 30%, ì ì‹¬ 40%, ì €ë… 30%)ì„ ê³ ë ¤í•˜ì—¬, ê° ì˜ì–‘ì„±ë¶„ì´ ì ì • ë²”ìœ„ ë‚´ì— ìžˆëŠ”ì§€ í‰ê°€. íŠ¹ì • ì˜ì–‘ì†Œì˜ ê³¼ë‹¤ ë˜ëŠ” ë¶€ì¡±ì„ ì£¼ìš” ê°ì  ìš”ì¸ìœ¼ë¡œ í•¨.

                    **ì˜ˆì‹œ (ì•„ì¹¨, ì ì‹¬ë§Œ ìžˆê³  ì €ë…ì´ ì—†ëŠ” ê²½ìš° - ë§ˆí¬ë‹¤ìš´ í˜•ì‹):**

                    ```markdown
                    ## â˜€ï¸ ì•„ì¹¨ ì‹ë‹¨ ë¶„ì„

                    **ì ìˆ˜: 85ì ** / 100ì 

                    ðŸ‘ **ìž˜í•œ ì **
                    * í†µê³¡ë¬¼ í† ìŠ¤íŠ¸ì™€ ê³„ëž€ìœ¼ë¡œ íƒ„ìˆ˜í™”ë¬¼ê³¼ ë‹¨ë°±ì§ˆì„ ê· í˜•ìžˆê²Œ ì‹œìž‘í–ˆì–´ìš”.

                    ðŸ’¡ **ê°œì„ í•  ì **
                    * ì‹ì´ì„¬ìœ ê°€ ì¡°ê¸ˆ ë¶€ì¡±í•´ìš”. ê³¼ì¼(ì‚¬ê³¼ ë°˜ ê°œ ë˜ëŠ” ë°”ë‚˜ë‚˜ í•œ ê°œ)ì„ ì¶”ê°€í•˜ë©´ ë”ìš± ì™„ë²½í•œ ì•„ì¹¨ì´ ë  ê±°ì˜ˆìš”.

                    ---
                    ## ðŸ¥— ì ì‹¬ ì‹ë‹¨ ë¶„ì„

                    **ì ìˆ˜: 75ì ** / 100ì 

                    ðŸ‘ **ìž˜í•œ ì **
                    * ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œë¡œ ì–‘ì§ˆì˜ ë‹¨ë°±ì§ˆê³¼ ì±„ì†Œë¥¼ ì¶©ë¶„ížˆ ì„­ì·¨í–ˆìŠµë‹ˆë‹¤.

                    ðŸ’¡ **ê°œì„ í•  ì **
                    * ë“œë ˆì‹±ì˜ ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ì„ í™•ì¸í•˜ê³ , ê°€ëŠ¥í•˜ë‹¤ë©´ ì˜¬ë¦¬ë¸Œ ì˜¤ì¼ ê¸°ë°˜ì˜ ì €ë‚˜íŠ¸ë¥¨ ë“œë ˆì‹±ìœ¼ë¡œ ë³€ê²½í•˜ê±°ë‚˜ ì–‘ì„ ì¤„ì—¬ë³´ì„¸ìš”.

                    ---
                    ## ðŸŒ™ ì €ë… ì‹ì‚¬ ê°€ì´ë“œ

                    ì €ë…ì—” **ë‘ë¶€ ìŠ¤í…Œì´í¬ì™€ ìƒëŸ¬ë“œ** ë˜ëŠ” **í˜„ë¯¸ë°¥ê³¼ ë¯¸ì—­êµ­** ê°™ì€ ê°€ë³ê³  ê±´ê°•í•œ ì‹ì‚¬ëŠ” ì–´ë– ì„¸ìš”? (íŒ: ì˜¤ëŠ˜ ì ì‹¬ì— ê³ ê¸°ë¥˜ë¥¼ ë“œì…¨ë‹¤ë©´, ì €ë…ì€ ìƒì„ ì´ë‚˜ ì±„ì†Œ ìœ„ì£¼ë¡œ ì„ íƒí•´ë³´ì„¸ìš”!)


                    2. ì•„ì¹¨, ì ì‹¬, ì €ë… ì‹ë‹¨ì´ ëª¨ë‘ ìžˆëŠ” ê²½ìš° (ì˜¤ì§ ì´ ê²½ìš°ì—ë§Œ í•´ë‹¹í•˜ë©°, ì´ ê²½ìš° ìœ„ 1ë²ˆì˜ ê°œë³„ ì‹ë‹¨ ë¶„ì„ì€ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤):
                    í•˜ë£¨ ì „ì²´ ì„­ì·¨ëŸ‰ì— ëŒ€í•œ **ì´ì  (100ì  ë§Œì , í…ìŠ¤íŠ¸ í˜•ì‹)**ê³¼ ì¢…í•©ì ì¸ ê°œì„ ì ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì œì‹œí•©ë‹ˆë‹¤. ê°œì„ ì  ì œì•ˆ ì‹œ, ë§¤ìš° êµ¬ì²´ì ì¸ ìŒì‹ ì¢…ë¥˜, ì–‘, ì¡°ë¦¬ë²• ë³€ê²½ ë“±ì„ ëª…ì‹œí•˜ì—¬ ì‚¬ìš©ìžê°€ ë°”ë¡œ í–‰ë™ìœ¼ë¡œ ì˜®ê¸¸ ìˆ˜ ìžˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
                    ì ìˆ˜ ì‚°ì • ê¸°ì¤€: í•˜ë£¨ ê¶Œìž¥ ì„­ì·¨ëŸ‰ ëŒ€ë¹„ ì´ ì„­ì·¨ëŸ‰ì˜ ê° ì˜ì–‘ì„±ë¶„ë³„ ì¶©ì¡±ë„ ë° ê· í˜•ë„ë¥¼ ì¢…í•©ì ìœ¼ë¡œ í‰ê°€. ì¹¼ë¡œë¦¬, í•„ìˆ˜ ì˜ì–‘ì†Œ(íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°©)ì˜ ì ì • ë¹„ìœ¨, ì‹ì´ì„¬ìœ , ë‹¹ë¶„, ë‚˜íŠ¸ë¥¨ ì„­ì·¨ëŸ‰ ë“±ì„ ê³ ë ¤.
                    ë§Œì•½ ê°„ì‹ ë°ì´í„°ê°€ ìžˆë‹¤ë©´, ê°„ì‹ ë¶„ì„ë„ ì´ ì´í‰ì— ìžì—°ìŠ¤ëŸ½ê²Œ í†µí•©í•˜ì—¬ ì–¸ê¸‰í•˜ê±°ë‚˜, ì•„ëž˜ 3ë²ˆ ê°€ì´ë“œë¼ì¸ì— ë”°ë¼ ë³„ë„ ì„¹ì…˜ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. (ì´í‰ì— ìžì—°ìŠ¤ëŸ½ê²Œ ë…¹ì´ëŠ” ê²ƒì„ ê¶Œìž¥)

                    ì˜ˆì‹œ (ì•„ì¹¨, ì ì‹¬, ì €ë… ì‹ë‹¨ì´ ëª¨ë‘ ìžˆëŠ” ê²½ìš° - ë§ˆí¬ë‹¤ìš´ í˜•ì‹):

                    Markdown

                    # ðŸ½ï¸ í•˜ë£¨ ì‹ë‹¨ ì´í‰

                    **ì¢…í•© ì ìˆ˜: 78ì ** / 100ì 

                    ## ðŸ“ˆ ìž˜í•˜ê³  ìžˆì–´ìš”!
                    * ì„¸ ë¼ ëª¨ë‘ ë‹¤ì–‘í•œ ì‹í’ˆêµ°ì„ í¬í•¨í•˜ì—¬ ì˜ì–‘ì†Œë¥¼ ë¹„êµì  ê· í˜• ìžˆê²Œ ì„­ì·¨í•˜ì…¨ìŠµë‹ˆë‹¤.
                    * ì‹ì´ì„¬ìœ  ì„­ì·¨ëŸ‰ì´ ê¶Œìž¥ëŸ‰(ì˜ˆ: 25g)ì— ë§¤ìš° ê°€ê¹ìŠµë‹ˆë‹¤. í›Œë¥­í•©ë‹ˆë‹¤!

                    ## ðŸ’¡ ê°œì„ í•˜ë©´ ì¢‹ì•„ìš”!
                    * **ë‹¨ë°±ì§ˆ ë³´ì¶©:** í•˜ë£¨ ê¶Œìž¥ëŸ‰ì— ë¹„í•´ ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ì•½ 15g ë¶€ì¡±í•©ë‹ˆë‹¤.
                        * **ì¶”ì²œ:** ë‚´ì¼ ì•„ì¹¨ ì‹ì‚¬ì— ê·¸ë¦­ìš”ê±°íŠ¸ 150gì„ ì¶”ê°€í•˜ê±°ë‚˜, ì ì‹¬ì— ë‹­ê°€ìŠ´ì‚´ ì–‘ì„ 50g ëŠ˜ë ¤ë³´ì„¸ìš”.
                    * **ë‚˜íŠ¸ë¥¨ ì¡°ì ˆ:** ë‚˜íŠ¸ë¥¨ ì„­ì·¨ê°€ ê¶Œìž¥ëŸ‰ë³´ë‹¤ ì•½ 300mg ë†’ìŠµë‹ˆë‹¤.
                        * **íŒ:** êµ­ë¬¼ ì„­ì·¨ë¥¼ í˜„ìž¬ì˜ ì ˆë°˜ìœ¼ë¡œ ì¤„ì´ê±°ë‚˜, ê°€ê³µì‹í’ˆ(ì˜ˆ: í–„, ì†Œì‹œì§€) ëŒ€ì‹  ìžì—° ì‹í’ˆì„ ì„ íƒí•´ë³´ì„¸ìš”.
                    * **ë‹¹ë¥˜ ê´€ë¦¬:** **[ê°„ì‹ëª…]**ìœ¼ë¡œ ì¸í•´ í•˜ë£¨ ë‹¹ë¥˜ ì„­ì·¨ê°€ ê¶Œìž¥ëŸ‰ì— ì‚´ì§ ê·¼ì ‘í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ê°„ì‹ìœ¼ë¡œëŠ” ë‹¹ í•¨ëŸ‰ì´ ë‚®ì€ **ê²¬ê³¼ë¥˜ í•œ ì¤Œ(ì•½ 20g)**ì´ë‚˜ **í”Œë ˆì¸ ìš”ê±°íŠ¸**ëŠ” ì–´ë– ì‹ ê°€ìš”? (ë§Œì•½ ê°„ì‹ì´ ì—†ë‹¤ë©´, 'í˜„ìž¬ ë‹¹ë¥˜ ì„­ì·¨ëŠ” ì ì ˆí•©ë‹ˆë‹¤. ê³„ì†í•´ì„œ ìŒë£Œë‚˜ ê°„ì‹ ì„ íƒ ì‹œ ë‹¹ í•¨ëŸ‰ì„ í™•ì¸í•˜ëŠ” ìŠµê´€ì„ ìœ ì§€í•´ì£¼ì„¸ìš”.' ì™€ ê°™ì´ í‘œí˜„)

                    3. ê°„ì‹ ë¶„ì„ - ì œê³µëœ ê²½ìš° (ë§ˆí¬ë‹¤ìš´ í˜•ì‹, ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ê¶Œìž¥):
                    ê°„ì‹ ë°ì´í„°ê°€ ìžˆëŠ” ê²½ìš°, ê°„ì‹ì— ëŒ€í•œ ë¶„ì„ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.

                    ìœ„ 1ë²ˆ ìƒí™© (ì£¼ìš” ì‹ë‹¨ ëˆ„ë½ ì‹œ): ê° ì‹ë‹¨ ë¶„ì„ê³¼ í•¨ê»˜ ë³„ë„ì˜ ê°„ì‹ ë¶„ì„ ì„¹ì…˜(ì˜ˆ: ## ðŸŽ ê°„ì‹ ë¶„ì„)ì„ ìƒì„±í•©ë‹ˆë‹¤.
                    ìœ„ 2ë²ˆ ìƒí™© (ëª¨ë“  ì£¼ìš” ì‹ë‹¨ ì¡´ìž¬ ì‹œ): í•˜ë£¨ ì´í‰ ë‚´ì— ê°„ì‹ì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ìžì—°ìŠ¤ëŸ½ê²Œ í¬í•¨ì‹œí‚¤ê±°ë‚˜ (ì˜ˆ: ë‹¹ë¥˜ ê´€ë¦¬ ë¶€ë¶„ì—ì„œ ì–¸ê¸‰), í•„ìš”í•˜ë‹¤ë©´ ë³„ë„ì˜ ê°„ì‹ ë¶„ì„ ì„¹ì…˜ì„ ì¶”ê°€í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. (ì´í‰ì— ìžì—°ìŠ¤ëŸ½ê²Œ ë…¹ì´ëŠ” ê²ƒì„ ë” ê¶Œìž¥) ì ìˆ˜ëŠ” í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ, ë‹¤ë¥¸ ì‹ë‹¨ê³¼ì˜ ì¡°í•©ì„ ê³ ë ¤í•˜ì—¬ í‰ê°€í•˜ê³ , ì¼ë°˜ì ì¸ ê±´ê°• ê°„ì‹ ê¸°ì¤€(ê³¼ë„í•œ ë‹¹ë¶„, ë‚˜íŠ¸ë¥¨, ì§€ë°© ì§€ì–‘)ì„ ë”°ë¦…ë‹ˆë‹¤.
                    ì˜ˆì‹œ (ë³„ë„ ê°„ì‹ ë¶„ì„ ì„¹ì…˜ - ë§ˆí¬ë‹¤ìš´ í˜•ì‹):

                    ## ðŸŽ ê°„ì‹ ë¶„ì„

                    **ì½”ë©˜íŠ¸:** ì˜¤ëŠ˜ ì„­ì·¨í•˜ì‹  ê°„ì‹ì€ **[ê°„ì‹ ì´ë¦„ ë˜ëŠ” ì¢…ë¥˜, ì˜ˆ: ì´ˆì½”ë°” 1ê°œ]**ë¡œ, ì•½ [ì¹¼ë¡œë¦¬ ê°’]kcalì´ë©° ë‹¹ë¥˜ê°€ [ê°’]g í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤. ì´ëŠ” í•˜ë£¨ ë‹¹ë¥˜ ì„­ì·¨ ê¶Œìž¥ëŸ‰ì˜ ì•½ [ë¹„ìœ¨]%ì— í•´ë‹¹í•˜ì—¬ ë‹¤ì†Œ ë†’ì€ íŽ¸ìž…ë‹ˆë‹¤. ë‹¤ìŒ ê°„ì‹ìœ¼ë¡œëŠ” **ì‹ ì„ í•œ ê³¼ì¼(ì˜ˆ: ì‚¬ê³¼ 1ê°œ)**ì´ë‚˜ **ë¬´ê°€ë‹¹ ìš”ê±°íŠ¸**ë¡œ ëŒ€ì²´í•˜ì—¬ ë‹¹ë¥˜ ì„­ì·¨ë¥¼ ì¡°ì ˆí•´ë³´ì‹œëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.
                
                    ë‚´ìš© ì „ë‹¬ ìµœì í™” ê°€ì´ë“œ (ë§ˆí¬ë‹¤ìš´ ìž‘ì„± ì‹œ):
                    í•µì‹¬ ì •ë³´ ìš°ì„ : ì‚¬ìš©ìžê°€ ê°€ìž¥ ê¶ê¸ˆí•´í•  ì ìˆ˜ì™€ ì£¼ìš” ê°œì„ ì /ì¹­ì°¬ì„ ìƒë‹¨ì— ë°°ì¹˜í•©ë‹ˆë‹¤.
                    ê°„ê²°í•œ ë¬¸ìž¥: ì§§ê³  ëª…í™•í•œ í‘œí˜„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    ì´ëª¨ì§€ í™œìš©: ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ ë‚´ì— ì´ëª¨ì§€ë¥¼ ì ì ˆížˆ ì‚¬ìš©í•˜ì—¬ ì‹œê°ì  ì£¼ëª©ë„ë¥¼ ë†’ì´ê³  ì •ë³´ë¥¼ ë¹ ë¥´ê²Œ êµ¬ë¶„í•  ìˆ˜ ìžˆë„ë¡ í•©ë‹ˆë‹¤. (ì˜ˆ: â˜€ï¸, ðŸ‘, ðŸ’¡)
                    ë¶ˆí•„ìš”í•œ ë°˜ë³µ ìµœì†Œí™”: ë™ì¼í•œ ë‚´ìš©ì´ ì—¬ëŸ¬ ë²ˆ ì–¸ê¸‰ë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
                    êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ ì œê³µ: "ë¶€ì¡±í•´ìš”", "ë§Žì•„ìš”" ë³´ë‹¤ëŠ” "ì•½ 15g ë¶€ì¡±í•´ìš”", "ì•½ 300mg ë†’ìŠµë‹ˆë‹¤" ì™€ ê°™ì´ ê°€ëŠ¥í•œ ê²½ìš° êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë¥¼ í•¨ê»˜ ì œì‹œí•˜ì—¬ ì‚¬ìš©ìžê°€ ëª…í™•ížˆ ì¸ì§€í•˜ë„ë¡ í•©ë‹ˆë‹¤.
                    ì‹¤ì²œ ê°€ëŠ¥í•œ ì œì•ˆ: ê°œì„ ì ì€ ì‚¬ìš©ìžê°€ ì‰½ê²Œ ì‹¤ì²œí•  ìˆ˜ ìžˆëŠ” **ë§¤ìš° êµ¬ì²´ì ì¸ ìŒì‹(ì˜ˆ: 'ë‘ë¶€ 1ëª¨', 'ì•„ëª¬ë“œ 10ì•Œ'), ì–‘(ì˜ˆ: 'ì•½ 100g'), ì¡°ë¦¬ë²•(ì˜ˆ: 'íŠ€ê¹€ ëŒ€ì‹  êµ¬ì´')**ì„ ì œì•ˆí•˜ì—¬ ì‚¬ìš©ìžì˜ í–‰ë™ ë³€í™”ë¥¼ ì ê·¹ì ìœ¼ë¡œ ìœ ë„í•©ë‹ˆë‹¤.

                    ```json
                    \(jsonInputString)
                    ```
                                                
                """

                await send(.aiResponse(Result {
                    try await firebaseAIService.generate(prompt)
                }))
            }
        case .aiResponse(.success(let text)):
            state.isLoading = false
            state.generatedResponse = text
            print("success - \(text)")
            return .none
        case .aiResponse(.failure(let error)):
            state.isLoading = false
            state.generatedResponse = "AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.: \(error.localizedDescription)"
            print("AI Error: \(error.localizedDescription)")
            return .none
        }
    }
}

struct FirebaseAIService {
    var generate: (_ prompt: String) async throws -> String
}

extension FirebaseAIService: DependencyKey {
    static var liveValue: Self = {
        let ai = FirebaseAI.firebaseAI(backend: .googleAI())
        
        let model = ai.generativeModel(modelName: "gemini-2.0-flash-lite")
        
        return Self(
            generate: { prompt in
                let response = try await model.generateContent(prompt)
                return response.text ?? "NO text in response"
            }
        )
    }()
}

extension DependencyValues {
    var firebaseAIService: FirebaseAIService {
        get { self[FirebaseAIService.self] }
        set { self[FirebaseAIService.self] = newValue }
    }
}

